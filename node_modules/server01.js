var express         =       require("express");
var multer          =       require('multer');
var app             =       express();
var upload      =   multer({ dest: './uploads/'});
var spawn = require('child_process').spawn;
var yandex = require('./doppelcamyandex')

app.use(express.static('uploads'));

app.use(multer({ dest: './uploads/',
    rename: function (fieldname, filename) {
        return filename+Date.now();
    },
    onFileUploadStart: function (file) {
        console.log(file.originalname + ' is starting ...');
    },
    onFileUploadComplete: function (file) {
        console.log(file.fieldname + ' uploaded to  /' + file.name)

    }
}));

app.get('/',function(req,res){
      res.sendFile(__dirname + "/index.html");
});

app.post('/api/photo',function(req,res){
    upload(req,res,function(err) {
        if(err) {
            console.log(err);
            return res.end("Error uploading file.");
        }
        var output = ''

        var uploadedUrl1 = 'http://107.170.164.22/'+res.req.files.userPhoto.name;
        var uploadedUrl2 = 'http://doppel.camera/'+res.req.files.userPhoto.name;
        console.log(uploadedUrl1);
        console.log(uploadedUrl2);
        //make the request to yandex
        //and then return the url of the yandex photo

        yandex.get_similar(uploadedUrl1, function(out) { 
            res.json(out);
        });


        //console.log('before casper');
        // var casper = spawn('casperjs', ['doppelcam.js', uploadedUrl2])
        // casper.stdout.on('data', function(data){
        //     console.log('Output: ' + output);
        //     output += '' + data;
        //     //res.redirect('/'+res.req.files.userPhoto.name)
        // });
        // casper.stderr.on('data', function(data){
        //     console.log("error: ", data);
        // });

        // casper.on('close', function(){
        //     console.log('Finished: ' + output);
        //     res.send(output);
        // });
    });
});

app.listen(80,function(){
    console.log("Working on port 80");
});